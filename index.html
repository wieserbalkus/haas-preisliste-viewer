<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Haas Artikelpreisliste Vertrieb</title>
<meta name="robots" content="noindex, nofollow">
<meta name="googlebot" content="noimageindex">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  (function(){
    const metaUrl = './data/app-meta.json';
    window.APP_META_URL = metaUrl;

    function applyMeta(meta){
      const defaults = {
        version: 'dev',
        buildDate: '',
        defaultFile: 'Artikelpreisliste.xlsx',
        defaultFilePath: './data/Artikelpreisliste.xlsx',
        buildSource: './data/Artikelpreisliste.xlsx'
      };
      const merged = Object.assign({}, defaults, meta || {});
      window.APP_META = merged;
      const versionParam = encodeURIComponent(merged.version || defaults.version);
      const head = document.getElementsByTagName('head')[0];

      function appendLink(href, extra){
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href + (href.includes('?') ? '&' : '?') + 'v=' + versionParam;
        if(extra){
          Object.entries(extra).forEach(([key,value])=>{
            if(value != null){ link.setAttribute(key, value); }
          });
        }
        head.appendChild(link);
      }

      function appendScript(src){
        return new Promise((resolve, reject)=>{
          const script = document.createElement('script');
          script.async = false;
          script.src = src + (src.includes('?') ? '&' : '?') + 'v=' + versionParam;
          script.onload = ()=>resolve();
          script.onerror = (evt)=>{
            const error = new Error('Skript konnte nicht geladen werden: ' + src);
            error.event = evt;
            reject(error);
          };
          head.appendChild(script);
        });
      }

      appendLink('./styles/app.css');
      appendLink('./styles/print.css', {media:'print'});
      const bootScripts = ['meta','storage','render','print','init'];
      const bootPromise = bootScripts.reduce(
        (chain, name)=>chain.then(()=>appendScript(`./scripts/${name}.js`)),
        Promise.resolve()
      );
      window.APP_BOOT_PROMISE = bootPromise;
      bootPromise.catch(err=>{
        console.error('Bootstrapping fehlgeschlagen.', err);
        window.APP_BOOT_ERROR = err;
      });

      function applyVersionedSrcs(){
        document.querySelectorAll('[data-versioned-src]').forEach(el=>{
          const base = el.getAttribute('data-versioned-src');
          if(!base) return;
          const sep = base.includes('?') ? '&' : '?';
          el.setAttribute('src', base + sep + 'v=' + versionParam);
        });
      }

      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', applyVersionedSrcs, {once:true});
      }else{
        applyVersionedSrcs();
      }
    }

    fetch(metaUrl + '?ts=' + Date.now(), {cache:'no-store'})
      .then(res=>{
        if(!res.ok){ throw new Error('Metadaten konnten nicht geladen werden.'); }
        return res.json();
      })
      .then(applyMeta)
      .catch(err=>{
        console.error(err);
        applyMeta();
      });
  })();
</script>
</head>
<body>
<div class="wrap">
  <div class="panel">

    <!-- ===== Steuerleiste (Titel oben, darunter Button; Logo Mitte) ===== -->
    <div class="controls" id="controls">
      <div class="controls-left">
        <span class="inline-title">Haas Artikelpreisliste</span>
        <!-- versteckter Datei-Input: nur Klick per Button -->
        <input id="file" type="file" accept=".xlsx,.xlsm" style="display:none" />
        <button id="reset" class="pill" title="Filter zur√ºcksetzen">Zur√ºcksetzen</button>
        <small id="hint" class="statusline" data-status="info"></small>
      </div>

      <div class="controls-center">
        <div class="brand"><img data-versioned-src="./assets/img/Logo_Haas.jpg" alt="Haas Logo"/></div>
      </div>

      <div class="controls-right">
        <span class="muted">
          Aktuell: <span id="currentFile" class="current">‚Äì keine ‚Äì</span> ¬∑
          <span id="count" class="muted"></span>
          <!-- << NEU: Anleitung-Link √∂ffnet in neuer Registerkarte -->
          <a href="anleitung.html" class="help-link" target="_blank" rel="noopener">[Anleitung]</a>
        </span>
        <select id="sheetSel" title="Blatt"></select>
        <!-- erscheint NUR wenn Autoload fehlschl√§gt -->
        <button id="manualBtn" class="pill" style="display:none" title="Datei manuell ausw√§hlen">Manuell ausw√§hlen‚Ä¶</button>
        <div class="status-version-row">
          <a href="versionen.html" class="version-chip version-link" id="versionChip" title="" target="_blank" rel="noopener">
            <span>Programmversion</span>
            <span class="badge" id="versionBadge">‚Äì</span>
          </a>
        </div>
      </div>
    </div>

    <!-- ===== Filter ===== -->
    <div class="filters" id="filters">
      <select id="groupFilter" class="row-wide" title="Obergruppe"><option value="">Obergruppe (alle)</option></select>
      <input id="fA" placeholder="Filter: Artikelnummer" />
      <input id="fB" placeholder="Filter: Kurztext" />
      <input id="fC" placeholder="Filter: Beschreibung" />
      <input id="search" class="global" placeholder="Globale Suche (alle Spalten)‚Ä¶" />
    </div>

    <!-- ===== Tabelle ===== -->
    <div class="table-wrap" id="tableWrap">
      <table class="data-table">
        <colgroup>
          <col style="width:90px"><col style="width:220px"><col style="width:46%"><col style="width:80px">
          <col class="col-ehinfo" style="width:80px"><col style="width:110px"><col style="width:200px"><col style="width:110px"><col style="width:34%">
        </colgroup>
        <thead id="thead">
          <tr>
            <th>Art.Nr.</th><th>Kurztext</th><th>Beschreibung</th><th>EH</th><th>EH-Info</th>
            <th id="thPreis" class="right no-sort">EH-Preis</th><th class="center">Menge/Alt./Hinzuf.</th><th class="right">Gesamtpreis</th><th>Hinweis</th>
          </tr>
        </thead>
        <tbody id="rows"><tr class="empty"><td colspan="9">Noch keine Daten geladen.</td></tr></tbody>
      </table>
    </div>

    <!-- ===== Bottom Drawer (Zusammenfassung) ===== -->
    <div class="summary" id="summary">
      <div class="drawer-head" id="drawerHead">
        <div class="drawer-left">
          <button id="toggleDrawer" class="drawer-toggle" type="button" title="Zusammenfassung ein-/ausblenden (Alt+O)">
            <span>Zusammenfassung</span><span>‚Ä¢</span><span id="selCount">0</span> Pos.<span>‚Äì</span>
            <span id="selSum" class="sum-delta">‚Ç¨ 0,00</span>
          </button>
        </div>
        <div class="drawer-right">
          <button id="printSummary" class="icon-btn" title="Zusammenfassung drucken"><i class="icon">üñ®Ô∏è</i></button>
        </div>
      </div>

      <div class="drawer-body">
        <h3>Markierte Positionen</h3>

        <!-- Meta (nur Vorschau/Eingabe) -->
        <div class="meta-inputs">
          <div><label for="bvhInput">BVH</label><br><input id="bvhInput" type="text" placeholder="Name des Bauvorhabens" /></div>
          <div><label for="auftragInput">Auftragsnummer</label><br><input id="auftragInput" type="text" placeholder="Auftragsnummer" /></div>
          <div><label for="erstellerInput">Ersteller</label><br><input id="erstellerInput" type="text" placeholder="Name des Erstellers" /></div>
          <div><label for="betreffInput">Betreff</label><br><input id="betreffInput" type="text" placeholder="z. B. Angebot Innenausbau" /></div>
        </div>

        <div id="summaryTableWrap"></div>
      </div>
    </div>

    <div id="toast" class="toast">Aktualisiert</div>
    <div id="printPortal" class="print-portal" aria-hidden="true"></div>
  </div>
</div>

</body>
</html>
