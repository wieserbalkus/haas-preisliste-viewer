<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Haas Artikelpreisliste Vertrieb</title>
<meta name="robots" content="noindex, nofollow">
<meta name="googlebot" content="noimageindex">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#f7f7f5;
    --card:#ffffff;
    --ink:#111827;
    --muted:#6b7280;
    --row:#fbfbfb;
    --head:#fff6e6;
    --accent:#f59e0b;
    --line:#e6e6e3;
    --drawer-h: 75vh;          /* ge√∂ffneter Drawer: H√∂he */
    --drawer-collapsed: 44px;  /* geschlossener Drawer: Men√ºh√∂he */
    --chrome-offset: 340px;    /* dynamisch per JS √ºberschrieben (Controls + Filter + thead) */
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:2000px;margin:28px auto;padding:0 16px}
  .panel{background:var(--card);border-radius:12px;box-shadow:0 6px 22px rgba(0,0,0,.06);overflow:hidden}

  /* ===== Steuerleiste (ohne obere graue Leiste) =====
     Grid:
       - links: Titel (oben) + Button (darunter)
       - mitte: Logo zentriert (optisch auf einer Linie mit Titel), Container mit fixer H√∂he,
                das Logo selbst ist absolut positioniert -> gr√∂√üer m√∂glich ohne Gesamth√∂he zu erh√∂hen
       - rechts: Dateistatus + Blattwahl
  */
  .controls{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    gap:12px;
    padding:10px 16px;
    border-bottom:1px solid var(--line);
    background:#fff;
  }
  .controls-left{
    display:flex;
    flex-direction:column;       /* Titel √ºber dem Button */
    align-items:flex-start;
    gap:6px;
    min-width:0;
  }
  .controls-center{
    position:relative;
    height:36px;                 /* Fixe Zeilenh√∂he -> Kopf bleibt flach */
    width:220px;                 /* sanfte Begrenzung, optional */
    overflow:visible;
    justify-self:center;
  }
  .controls-right{
    justify-self:end;
    display:flex;flex-direction:column;align-items:flex-end;gap:6px;
  }

  /* Gr√∂√üeres Logo, ohne Schatten/Animation, in der Mitte vertikal ausgerichtet */
  .brand img{
    position:absolute;left:50%;top:50%;
    transform:translate(-50%,-50%);
    height:64px;                 /* << gr√∂√üerer Logo-Wert */
    display:block;
  }
  @media (max-width:700px){ .brand img{height:52px} }

  /* Formelemente in der Steuerleiste */
  .controls select{height:36px;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px}
  .controls button{height:36px;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px}

  /* Flacherer Pill-Button (z.B. Zur√ºcksetzen + manueller Button) */
  .pill{
    background:var(--accent);color:#fff;border:none;cursor:pointer;
    height:32px !important;      /* etwas flacher */
    padding:6px 10px !important;
  }
  .pill:hover{filter:brightness(.95)}

  .muted{color:var(--muted)}
  .current{font-weight:600}
  .inline-title{
    font-size:16px;font-weight:600;line-height:1;margin:2px 0 2px 0;
    white-space:nowrap;
  }

  .statusline{display:block;max-width:520px;text-align:right;font-size:12px;line-height:1.2;color:var(--muted);min-height:1.2em}
  .statusline[data-status="ok"]::before{content:"‚úì ";font-weight:700}
  .statusline[data-status="info"]::before{content:"‚ÑπÔ∏é ";font-weight:700}
  .statusline[data-status="warn"]::before{content:"‚ö†Ô∏é ";font-weight:700}

  /* << NEU: Stil f√ºr den [Anleitung]-Link rechts oben */
  .help-link{
    margin-left:8px;
    font-size:12px;
    text-decoration:underline;
    color: var(--accent);
    white-space:nowrap;
  }
  .help-link:hover{ filter:brightness(.95); }

  @media (max-width:720px){
    .controls{grid-template-columns: 1fr 1fr; grid-template-areas:
      "left right"
      "center center";
    }
    .controls-left{grid-area:left}
    .controls-center{grid-area:center;margin-top:4px}
    .controls-right{grid-area:right;align-items:stretch}
    .statusline{text-align:left}
  }

  /* ===== Filter ===== */
  .filters{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;padding:8px 16px;border-bottom:1px solid var(--line);background:#fffdf6}
  .filters input, .filters select{height:30px;padding:4px 6px;border:1px solid #d1d5db;border-radius:6px}
  .filters .row-wide{grid-column:1/-1}

  /* ===== Tabelle / Scrollverhalten ===== */
  .table-wrap{
    overflow:auto;border-top:1px solid var(--line);
    height: calc(100vh - var(--chrome-offset) - var(--drawer-collapsed));
    max-height: calc(100vh - var(--chrome-offset) - var(--drawer-collapsed));
  }
  body.drawer-open .table-wrap{
    height: calc(100vh - var(--chrome-offset) - var(--drawer-h));
    max-height: calc(100vh - var(--chrome-offset) - var(--drawer-h));
  }

  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  thead th{position:sticky;top:0;background:var(--head);z-index:20;text-align:left;font-weight:600;padding:8px;border-bottom:1px solid #d8dee6}
  thead th:first-child{left:0;z-index:21}
  td:first-child{position:sticky;left:0;background:inherit;z-index:10}

  tbody tr.group{background:#fff9ed}
  tbody tr.group td:first-child{z-index:11}
  tbody tr.group{ scroll-margin-top: 52px; }

  tbody td{padding:6px 8px;border-bottom:1px solid #eef0f3;vertical-align:top}
  tbody tr:nth-child(even):not(.group){background:var(--row)}
  .right{text-align:right}
  .empty{padding:24px;text-align:center;color:var(--muted)}
  .desc{white-space:pre-wrap;line-height:1.35em;word-break:break-word;overflow-wrap:anywhere}
  .sortable{cursor:pointer}
  .sortable:after{content:"‚Üï";font-size:12px;margin-left:6px;opacity:.6}
  .qty{width:70px;text-align:right}
  .qty::placeholder{color:#bbb}

  .qty-wrap{display:flex;align-items:center;gap:6px}
  .addbtn{width:28px;height:28px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;line-height:1;display:inline-flex;align-items:center;justify-content:center}
  .addbtn:hover{background:#fff9f0;border-color:#f59e0b}
  .addbtn.added{background:#f59e0b;color:#fff;border-color:#f59e0b}
  .addbtn:disabled{opacity:.4;cursor:not-allowed}

  .cell-edit{width:100%;border:1px solid #d1d5db;border-radius:6px;padding:6px 8px;font:inherit;color:inherit;background:#fff}
  .cell-edit.ta{min-height:28px;height:34px;resize:vertical;overflow:hidden;line-height:1.25}
  .cell-edit.price{ text-align:right }
  .cell-edit:focus{outline:2px solid #f59e0b22;border-color:#f59e0b}

  .desc a{ text-decoration:underline; word-break:break-all; }

  /* ===== Bottom Drawer ===== */
  .summary{
    position:fixed;left:0;right:0;bottom:0;margin:0;border-top:1px solid var(--line);
    background:#fff;transform:translateY(calc(100% - var(--drawer-collapsed)));
    transition:transform .18s ease;z-index:1000;padding:0;box-shadow:0 -10px 28px rgba(0,0,0,.12);
  }
  .summary.open{ transform:translateY(0); }
  .drawer-head{display:flex;align-items:center;justify-content:space-between;gap:10px;height:var(--drawer-collapsed);padding:0 10px 0 6px;background:#fffdf6;border-bottom:1px solid var(--line)}
  .drawer-left{display:flex;align-items:center;gap:10px;width:100%}
  .drawer-toggle{display:flex;align-items:center;gap:10px;height:32px;padding:0 12px;border:1px solid #e6e6e3;border-radius:999px;background:#fff;cursor:pointer;font-weight:700}
  .drawer-toggle:hover{background:#fff9f0;border-color:#f59e0b80}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid #e6e6e3;border-radius:8px;background:#fff;cursor:pointer}
  .icon-btn:hover{background:#fff9f0;border-color:#f59e0b80}
  .icon{font-style:normal;line-height:1;font-size:16px}
  .drawer-body{height:var(--drawer-h);overflow:auto;padding:10px 16px 14px}
  .summary h3{margin:6px 0 8px 0;font-size:15px}
  .summary table{width:100%;table-layout:auto}
  .summary th,.summary td{padding:6px 8px;border-bottom:1px dashed #eee}
  .summary .tot{font-weight:700}
  .neg{color:#b91c1c;font-weight:600}

  .meta-inputs{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}
  .meta-inputs label{font-size:12px;color:var(--muted)}
  .meta-inputs input{height:34px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px;min-width:220px}

  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(245,158,11,.0)}40%{box-shadow:0 0 0 6px rgba(245,158,11,.25)}100%{box-shadow:0 0 0 0 rgba(245,158,11,.0)}}
  .drawer-head.pulse{animation:pulse .8s ease}

  .sum-delta{transition:filter .3s, color .3s}
  .sum-up::after{content:" ‚ñ≤";font-weight:700}
  .sum-down::after{content:" ‚ñº";font-weight:700}
  .sum-up{color:#166534}
  .sum-down{color:#b91c1c}

  .toast{
    position:fixed;left:14px;bottom:56px;background:#111827;color:#fff;padding:8px 12px;border-radius:10px;font-size:12px;box-shadow:0 6px 18px rgba(0,0,0,.2);
    opacity:0;transform:translateY(6px);pointer-events:none;transition:opacity .18s ease, transform .18s ease;z-index:1100
  }
  .toast.show{opacity:1;transform:translateY(0)}

  @media print{
    .controls,.filters,.table-wrap{display:none}
    .summary{border:none;padding:0; position:static; transform:none; box-shadow:none}
    .meta-inputs{display:none}
    #summaryTableWrap table th,#summaryTableWrap table td{ display: table-cell !important; visibility: visible !important; }
    thead th{ background:#fff6e6 !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  }

  @media (max-width:1200px){
    .data-table .col-ehinfo{display:none}
    .data-table thead th:nth-child(5), .data-table tbody td:nth-child(5){display:none}
  }
  @media (max-width:980px){ thead th,tbody td{padding:6px 6px} td.right,th.right{font-size:13px} }
  @media (max-width:720px){ tbody td{padding:5px 6px} .desc{line-height:1.25} }

  mark.hl{
    background:#fde68a;
    color:inherit;
    padding:0 0.1em;
    border-radius:3px;
    box-shadow:0 0 0 1px #f59e0b66 inset;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">

    <!-- ===== Steuerleiste (Titel oben, darunter Button; Logo Mitte) ===== -->
    <div class="controls" id="controls">
      <div class="controls-left">
        <span class="inline-title">Haas Artikelpreisliste (Vertrieb)</span>
        <!-- versteckter Datei-Input: nur Klick per Button -->
        <input id="file" type="file" accept=".xlsx,.xlsm" style="display:none" />
        <button id="reset" class="pill" title="Filter zur√ºcksetzen">Zur√ºcksetzen</button>
      </div>

      <div class="controls-center">
        <div class="brand"><img src="Logo_Haas.jpg" alt="Haas Logo"/></div>
      </div>

      <div class="controls-right">
        <span class="muted">
          Aktuell: <span id="currentFile" class="current">‚Äì keine ‚Äì</span> ¬∑
          <span id="count" class="muted"></span>
          <!-- << NEU: Anleitung-Link √∂ffnet in neuer Registerkarte -->
          <a href="anleitung.html" class="help-link" target="_blank" rel="noopener">[Anleitung]</a>
        </span>
        <select id="sheetSel" title="Blatt"></select>
        <!-- erscheint NUR wenn Autoload fehlschl√§gt -->
        <button id="manualBtn" class="pill" style="display:none" title="Datei manuell ausw√§hlen">Manuell ausw√§hlen‚Ä¶</button>
        <small id="hint" class="statusline" data-status="info"></small>
      </div>
    </div>

    <!-- ===== Filter ===== -->
    <div class="filters" id="filters">
      <select id="groupFilter" class="row-wide" title="Obergruppe"><option value="">Obergruppe (alle)</option></select>
      <input id="fA" placeholder="Filter: Artikelnummer" />
      <input id="fB" placeholder="Filter: Kurztext" />
      <input id="fC" placeholder="Filter: Beschreibung" />
      <input id="search" class="global" placeholder="Globale Suche (alle Spalten)‚Ä¶" />
    </div>

    <!-- ===== Tabelle ===== -->
    <div class="table-wrap" id="tableWrap">
      <table class="data-table">
        <colgroup>
          <col style="width:90px"><col style="width:220px"><col style="width:40%"><col style="width:80px">
          <col class="col-ehinfo" style="width:80px"><col style="width:100px"><col style="width:140px"><col style="width:100px"><col style="width:34%">
        </colgroup>
        <thead id="thead">
          <tr>
            <th>Art.Nr.</th><th>Kurztext</th><th>Beschreibung</th><th>EH</th><th>EH-Info</th>
            <th id="thPreis" class="right sortable">EH-Preis</th><th>Menge</th><th class="right">Gesamtpreis</th><th>Hinweis</th>
          </tr>
        </thead>
        <tbody id="rows"><tr class="empty"><td colspan="9">Noch keine Daten geladen.</td></tr></tbody>
      </table>
    </div>

    <!-- ===== Bottom Drawer (Zusammenfassung) ===== -->
    <div class="summary" id="summary">
      <div class="drawer-head" id="drawerHead">
        <div class="drawer-left">
          <button id="toggleDrawer" class="drawer-toggle" type="button" title="Zusammenfassung ein-/ausblenden (Alt+O)">
            <span>Zusammenfassung</span><span>‚Ä¢</span><span id="selCount">0</span> Pos.<span>‚Äì</span>
            <span id="selSum" class="sum-delta">‚Ç¨ 0,00</span>
          </button>
        </div>
        <div class="drawer-right">
          <button id="printSummary" class="icon-btn" title="Zusammenfassung drucken"><i class="icon">üñ®Ô∏è</i></button>
        </div>
      </div>

      <div class="drawer-body">
        <h3>Markierte Positionen</h3>

        <!-- Meta (nur Vorschau/Eingabe) -->
        <div class="meta-inputs">
          <div><label for="bvhInput">BVH</label><br><input id="bvhInput" type="text" placeholder="Name des Bauvorhabens" /></div>
          <div><label for="auftragInput">Auftragsnummer</label><br><input id="auftragInput" type="text" placeholder="Auftragsnummer" /></div>
          <div><label for="erstellerInput">Ersteller</label><br><input id="erstellerInput" type="text" placeholder="Name des Erstellers" /></div>
          <div><label for="betreffInput">Betreff</label><br><input id="betreffInput" type="text" placeholder="z. B. Angebot Innenausbau" /></div>
        </div>

        <div id="summaryTableWrap"></div>
      </div>
    </div>

    <div id="toast" class="toast">Aktualisiert</div>
  </div>
</div>

<script>
/* ================= Basis-Einstellungen ================ */
const DEFAULT_FILE = 'Artikelpreisliste.xlsx';
const STORAGE_KEY  = 'plv22_state';
const QTY_MAX      = 999.99;

/* ================= Hilfsfunktionen ==================== */
function $(q){return document.querySelector(q)}
function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;')}
function isGroupId(id){ const s=String(id||"").replace(/\D/g,""); if(!s) return false; const n=parseInt(s,10); return Number.isFinite(n) && n%100===0; }
function parseEuro(str){ if(str==null) return NaN; let s=String(str).trim(); if(!s) return NaN; if(s.includes(',')) s=s.replace(/\./g,'').replace(',', '.'); return Number(s); }
function fmtPrice(v){ const n=parseEuro(v); return Number.isFinite(n)? n.toLocaleString('de-AT',{style:'currency',currency:'EUR'}) : (v??''); }
function debounced(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
let statusTimer=null;
function setStatus(kind, html, ttl=3000){
  const el = $('#hint');
  if(!kind){ el.textContent=''; el.removeAttribute('data-status'); if(statusTimer){clearTimeout(statusTimer)}; return; }
  el.dataset.status = kind; el.innerHTML = html || '';
  if(statusTimer){ clearTimeout(statusTimer); }
  statusTimer = setTimeout(()=>{ el.textContent=''; el.removeAttribute('data-status'); }, ttl);
}
function isSonderEditable(id){ const s=String(id||'').replace(/\D/g,''); return /(?:98|99)$/.test(s); }

/* Menge parsing (¬±0‚Äì999,99) */
const QTY_RE=/^-?\d{1,3}([.]\d{1,2})?$/;
function parseQty(str){ if(str==null)return 0; let s=String(str).trim().replace(',', '.'); if(!s)return 0; if(!QTY_RE.test(s))return NaN; const n=Number(s); if(!Number.isFinite(n)||Math.abs(n)>QTY_MAX)return NaN; return n; }
function fmtQty(n){ return Number.isFinite(n)? n.toLocaleString('de-AT',{minimumFractionDigits:0, maximumFractionDigits:2}) : ''; }

/* ====== Hervorhebung (PDF-Style) + Linkify ====== */
function escRe(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function splitTerms(s){ if(!s) return []; return String(s).trim().split(/\s+/).filter(Boolean); }
function makeRegex(terms){
  const t = [...new Set(terms.filter(Boolean))].sort((a,b)=>b.length-a.length);
  if(!t.length) return null;
  return new RegExp('(' + t.map(escRe).join('|') + ')','gi');
}
function hi(text, terms){
  const s = String(text ?? '');
  if(!s) return '';
  const rx = makeRegex(terms);
  if(!rx) return escapeHtml(s);
  const esc = escapeHtml(s);
  return esc.replace(rx, '<mark class="hl">$1</mark>');
}
function toSafeHref(raw){
  if(!raw) return '';
  let s = String(raw).trim();
  if(/^mailto:/i.test(s)) return s;
  if(/^[\w.+-]+@[\w.-]+\.[A-Za-z]{2,}$/.test(s)) return 'mailto:'+s;
  if(!/^(https?:)?\/\//i.test(s)){
    if(/^www\./i.test(s)) s = 'http://' + s;
    else if (/^[A-Za-z][A-Za-z0-9+.-]*:/.test(s)) return '';
  }
  if(!/^https?:\/\//i.test(s)) s = s;
  return s;
}
function linkify(escapedHtml){
  if(!escapedHtml) return '';
  const URL_RE = /\b((https?:\/\/|www\.)[^\s<]+[^\s<\.)])/gi;
  const MAIL_RE = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi;
  return escapedHtml.split(/(<[^>]+>)/g).map(part=>{
    if(part.startsWith('<')) return part;
    return part
      .replace(URL_RE, (m)=>{
        const href = toSafeHref(m);
        if(!href) return m;
        return `<a href="${href}" target="_blank" rel="noopener noreferrer">${m}</a>`;
      })
      .replace(MAIL_RE, (m)=>{
        const href = toSafeHref(m);
        return `<a href="${href}" target="_blank" rel="noopener noreferrer">${m}</a>`;
      });
  }).join('');
}
function hlAndLink(text, terms){
  const highlighted = hi(text, terms);
  return linkify(highlighted);
}

/* ========= Zustandsverwaltung (Filter/Meta) =========== */
function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch{ return {}; } }
function saveState(patch){
  const st = loadState();
  const next = Object.assign({}, st, patch);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
}
function saveFilters(){
  const filters={ q:$('#search').value||'', A:$('#fA').value||'', B:$('#fB').value||'', C:$('#fC').value||'', group:$('#groupFilter').value||'' };
  saveState({filters});
}
function saveMeta(){
  const meta={ bvh:$('#bvhInput').value||'', auftrag:$('#auftragInput').value||'', ersteller:$('#erstellerInput').value||'', betreff:$('#betreffInput').value||'' };
  saveState({meta});
}

/* ================== State ============================= */
let GROUPS=[], LAST_WB=null, SORT={col:null,dir:1};
let DRAWER_OPEN = false;
let CURRENT_SHEET = '';
const SELECTED = new Map();

/* ================= Excel lesen ======================== */
function extractRows(ws){
  try{
    const ref = ws['!ref']; if(!ref) throw new Error('Kein Zellbereich (!ref).');
    const range = XLSX.utils.decode_range(ref);
    const out = [];
    for(let r=range.s.r;r<=range.e.r;r++){
      const C = (c)=>ws[XLSX.utils.encode_cell({r,c})];
      const A=C(0),B=C(1),C2=C(2),D=C(3),E=C(4),F=C(5),G=C(6);
      const id  = A&&A.v!=null?String(A.v).trim():'';
      const kurz= B&&B.v!=null?String(B.v).trim():'';
      const beschr = C2&&C2.v!=null?String(C2.v).trim():'';
      if(!(id||kurz||beschr)) continue;

      const linkB = (B && B.l && B.l.Target) ? String(B.l.Target) : '';
      const linkC = (C2 && C2.l && C2.l.Target) ? String(C2.l.Target) : '';
      const linkG = (G && G.l && G.l.Target) ? String(G.l.Target) : '';

      out.push({
        id,
        kurz_raw:kurz, beschreibung_raw:beschr,
        styleB:{ bold:!!(B&&B.s&&B.s.font&&B.s.font.bold), underline:!!(B&&B.s&&B.s.font&&(B.s.font.underline||B.s.font.u)) },
        styleC:{ bold:!!(C2&&C2.s&&C2.s.font&&C2.s.font.bold), underline:!!(C2&&C2.s&&C2.s.font&&(C2.s.font.underline||C2.s.font.u)) },
        einheit:D&&D.v!=null?String(D.v).trim():'', einheitInfo:E&&E.v!=null?String(E.v).trim():'', preis:F?F.v:'', hinweis_raw:G&&G.v!=null?String(G.v).trim():'',
        linkB, linkC, linkG
      });
    }
    return out;
  }catch{
    const json=XLSX.utils.sheet_to_json(ws,{defval:""}); if(!json.length) return [];
    const k=Object.keys(json[0]);
    return json.map(r=>({ id:String(r[k[0]]||'').trim(), kurz_raw:String(r[k[1]]||'').trim(), beschreibung_raw:String(r[k[2]]||'').trim(),
      einheit:String(r[k[3]]||'').trim(), einheitInfo:String(r[k[4]]||'').trim(), preis:r[k[5]], hinweis_raw:String(r[k[6]]||'').trim(),
      styleB:null, styleC:null, linkB:'', linkC:'', linkG:'' }));
  }
}
function buildGroups(rows){
  const groups=[]; let cur=null;
  for(const r of rows){
    if(isGroupId(r.id)){ cur={groupId:r.id,title:(r.kurz_raw||r.beschreibung_raw),children:[]}; groups.push(cur); }
    else if(cur){ cur.children.push(r); }
  }
  return groups;
}

/* ================= Render ============================= */
function autoGrow(el){ el.style.height='auto'; el.style.height = (el.scrollHeight)+'px'; }

function trGroup(g, f){
  const tr=document.createElement('tr');
  tr.className='group';
  tr.id = 'grp_'+g.groupId;
  const title = f && f.q ? hlAndLink(g.title||'', splitTerms(f.q)) : escapeHtml(g.title||'');
  tr.innerHTML=`<td colspan="9"><strong>${escapeHtml(g.groupId)} ‚Äì ${title}</strong></td>`;
  return tr;
}

function trChild(c, f){
  const tr=document.createElement('tr');
  const editable=isSonderEditable(c.id);
  let preisNum=parseEuro(c.preis);

  const qTerms = f ? splitTerms(f.q) : [];
  const tID = [...qTerms, f?.A].filter(Boolean);
  const tK  = [...qTerms, f?.B].filter(Boolean);
  const tB  = [...qTerms, f?.C].filter(Boolean);
  const tG  = qTerms;

  const kurzStatic = c.linkB
    ? `<div class="desc"><a href="${escapeHtml(toSafeHref(c.linkB))}" target="_blank" rel="noopener noreferrer">${hi(c.kurz_raw, tK)}</a></div>`
    : `<div class="desc">${hlAndLink(c.kurz_raw, tK)}</div>`;

  const beschrStatic = c.linkC
    ? `<div class="desc"><a href="${escapeHtml(toSafeHref(c.linkC))}" target="_blank" rel="noopener noreferrer">${hi(c.beschreibung_raw, tB)}</a></div>`
    : `<div class="desc">${hlAndLink(c.beschreibung_raw, tB)}</div>`;

  const ehHTML = editable
    ? `<input class="cell-edit" data-field="einheit" value="${escapeHtml(c.einheit||'')}" />`
    : hlAndLink(c.einheit||'', tG);

  const ehInfoHTML = editable
    ? `<input class="cell-edit" data-field="einheitInfo" value="${escapeHtml(c.einheitInfo||'')}" />`
    : hlAndLink(c.einheitInfo||'', tG);

  const preisHTML = editable
    ? `<input class="cell-edit price" data-field="preis" inputmode="decimal" placeholder="0" value="${Number.isFinite(preisNum)? String(preisNum).replace('.',',') : ''}" />`
    : hlAndLink(fmtPrice(c.preis), tG);

  const hinweisHTML = c.linkG
    ? `<div class="desc"><a href="${escapeHtml(toSafeHref(c.linkG))}" target="_blank" rel="noopener noreferrer">${hi(c.hinweis_raw||'', tG)}</a></div>`
    : `<div class="desc">${hlAndLink(c.hinweis_raw||'', tG)}</div>`;

  const kurzHTML = editable
    ? `<textarea class="cell-edit ta" data-field="kurz">${escapeHtml(c.kurz_raw)}</textarea>`
    : kurzStatic;

  const beschrHTML = editable
    ? `<textarea class="cell-edit ta" data-field="beschreibung">${escapeHtml(c.beschreibung_raw)}</textarea>`
    : beschrStatic;

  const qtyId=`q_${c.id}`, addBtnId=`add_${c.id}`;
  const qtyHTML = `<div class="qty-wrap">
      <input id="${qtyId}" class="qty" type="text" inputmode="decimal" placeholder="0" maxlength="7" title="Menge (¬±0‚Äì999,99)" />
      <button id="${addBtnId}" type="button" class="addbtn" title="Zur Zusammenfassung hinzuf√ºgen">‚ûï</button>
    </div>`;

  tr.innerHTML = `
    <td>${hlAndLink(c.id, tID)}</td>
    <td>${kurzHTML}</td>
    <td>${beschrHTML}</td>
    <td>${ehHTML}</td>
    <td>${ehInfoHTML}</td>
    <td class="right" data-sort="${preisNum}">${preisHTML}</td>
    <td>${qtyHTML}</td>
    <td class="right" data-total="0">‚Äì</td>
    <td class="desc">${hinweisHTML}</td>`;

  setTimeout(()=>{
    tr.querySelectorAll('textarea.cell-edit.ta').forEach(ta=>{
      autoGrow(ta); ta.addEventListener('input',()=>{ autoGrow(ta); if(SELECTED.has(c.id)) addOrUpdateSelectedFromRow(tr,c.id); });
    });
    const qtyInp=tr.querySelector('#'+CSS.escape(qtyId));
    const preisInp=tr.querySelector('input[data-field="preis"]');
    const totalCell=tr.querySelector('[data-total]');
    const addBtn=tr.querySelector('#'+CSS.escape(addBtnId));

    function currentPreis(){ if(preisInp){ const p=parseEuro(preisInp.value); return Number.isFinite(p)?p:0; } return Number.isFinite(preisNum)?preisNum:0; }
    function currentKurz(){ const k=tr.querySelector('[data-field="kurz"]'); return k?k.value.trim():tr.querySelector('td:nth-child(2)').innerText.trim(); }
    function currentBeschr(){ const b=tr.querySelector('[data-field="beschreibung"]'); return b?b.value.trim():tr.querySelector('td:nth-child(3)').innerText.trim(); }
    function currentEH(){ const e=tr.querySelector('[data-field="einheit"]'); return e?e.value.trim():(c.einheit||''); }

    function recalcRowTotal(){
      const q=parseQty(qtyInp?.value??''); const p=currentPreis();
      if(Number.isNaN(q)||q===0){
        totalCell.textContent='‚Äì'; totalCell.dataset.total='0'; totalCell.classList.toggle('neg',false);
        if(SELECTED.has(c.id)){ SELECTED.delete(c.id); addBtn.classList.remove('added'); addBtn.textContent='‚ûï'; renderSummary(true); }
      }else{
        const total=p*q; totalCell.textContent=fmtPrice(total); totalCell.dataset.total=String(total); totalCell.classList.toggle('neg',total<0);
        if(SELECTED.has(c.id)){
          SELECTED.set(c.id,{id:c.id,kurz:currentKurz(),beschreibung:currentBeschr(),eh:currentEH(),preisNum:p,qtyNum:q,totalNum:total});
          renderSummary(true);
        }
      }
    }
    function addOrUpdateSelectedFromRow(trEl,id){
      const q=parseQty(qtyInp?.value??''); if(Number.isNaN(q)||q===0){ return false; }
      const p=currentPreis(); const total=p*q;
      SELECTED.set(id,{id,kurz:currentKurz(),beschreibung:currentBeschr(),eh:currentEH(),preisNum:p,qtyNum:q,totalNum:total});
      return true;
    }
    window.addOrUpdateSelectedFromRow=addOrUpdateSelectedFromRow;

    qtyInp?.addEventListener('input',()=>{ qtyInp.value=qtyInp.value.replace(/[^\d.,-]/g,'').replace(/(?!^)-/g,''); recalcRowTotal(); });
    preisInp?.addEventListener('input',()=>{ if(!/^[\d.,-]*$/.test(preisInp.value)){ preisInp.value=preisInp.value.replace(/[^\d.,-]/g,''); } preisInp.closest('td').dataset.sort=String(currentPreis()); recalcRowTotal(); });

    addBtn.addEventListener('click',()=>{
      if(SELECTED.has(c.id)){ SELECTED.delete(c.id); addBtn.classList.remove('added'); addBtn.textContent='‚ûï'; renderSummary(true); return; }
      const ok=addOrUpdateSelectedFromRow(tr,c.id);
      if(ok){ addBtn.classList.add('added'); addBtn.textContent='‚úîÔ∏é'; renderSummary(true); setStatus('ok','Bereit.',1500); }
      else { setStatus('warn','Bitte zuerst eine g√ºltige Menge (‚â† 0) eingeben.',3500); addBtn.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}],{duration:160}); }
    });

    if(SELECTED.has(c.id)){
      const sel=SELECTED.get(c.id);
      if(qtyInp) qtyInp.value=String(sel.qtyNum).replace('.',',');
      const preisInp2=tr.querySelector('input[data-field="preis"]'); if(preisInp2&&Number.isFinite(sel.preisNum)){ preisInp2.value=String(sel.preisNum).replace('.',','); }
      addBtn.classList.add('added'); addBtn.textContent='‚úîÔ∏é'; recalcRowTotal();
    }
    recalcRowTotal();
  },0);

  return tr;
}

function currentFilters(){ return { q:($('#search').value||'').toLowerCase(), A:($('#fA').value||'').toLowerCase(), B:($('#fB').value||'').toLowerCase(), C:($('#fC').value||'').toLowerCase(), group:$('#groupFilter').value } }
function matchesFilters(row,f){
  const fields=[row.id,row.kurz_raw,row.beschreibung_raw,row.einheit,row.einheitInfo,String(row.preis),row.hinweis_raw].map(x=>String(x||'').toLowerCase());
  const [a,b,c]=[fields[0],fields[1],fields[2]];
  const global=!f.q||fields.some(v=>v.includes(f.q));
  const spec=(!f.A||a.includes(f.A))&&(!f.B||b.includes(f.B))&&(!f.C||c.includes(f.C));
  return global&&spec;
}
function fillGroupFilter(){
  const sel=$('#groupFilter'); const val=sel.value;
  sel.innerHTML='<option value="">Obergruppe (alle)</option>'+GROUPS.map(g=>`<option value="${g.groupId}">${escapeHtml(g.title||'')}</option>`).join('');
  if([...sel.options].some(o=>o.value===val)) sel.value=val;
}
function render(){
  const body=$('#rows'); body.innerHTML='';
  const f=currentFilters(); let rendered=0, groupCount=0, posCount=0;
  const sortPreis = SORT.col==='preis' ? SORT.dir : 0;
  const groups=GROUPS.filter(g=>!f.group||g.groupId===f.group);
  for(const g of groups){
    const groupMatch=matchesFilters({id:g.groupId,kurz_raw:g.title,beschreibung_raw:g.title,einheit:'',einheitInfo:'',preis:'',hinweis_raw:''},f);
    let children=g.children.filter(c=>matchesFilters(c,f));
    if(sortPreis) children=children.slice().sort((a,b)=>(parseEuro(a.preis)-parseEuro(b.preis))*sortPreis);
    if(!groupMatch && !children.length) continue;
    body.appendChild(trGroup(g, f)); rendered++; groupCount++;
    const list=groupMatch?g.children:children;
    for(const c of list){ body.appendChild(trChild(c, f)); rendered++; posCount++; }
  }
  if(rendered===0){ const tr=document.createElement('tr'); tr.className='empty'; tr.innerHTML='<td colspan="9">Keine Positionen gefunden.</td>'; body.appendChild(tr); }
  $('#count').textContent=`${groupCount} Gruppen ¬∑ ${posCount} Positionen sichtbar`;
  saveFilters();
}

/* >>> Immer zum Listenanfang springen */
function jumpToTop(){ $('#tableWrap').scrollTop = 0; }

/* ===== Dynamische H√∂he ===== */
function recomputeChromeOffset(){
  const controls = document.getElementById('controls');
  const filters = document.getElementById('filters');
  const thead = document.getElementById('thead');
  const h = (controls?.offsetHeight||0) + (filters?.offsetHeight||0) + (thead?.offsetHeight||0);
  document.documentElement.style.setProperty('--chrome-offset', h + 'px');
}
const ro = new ResizeObserver(()=>recomputeChromeOffset());
['#controls','#filters','#thead'].forEach(sel=>{
  const el = document.querySelector(sel);
  if(el) ro.observe(el);
});
window.addEventListener('resize', recomputeChromeOffset);

/* ================= Workbook =========================== */
async function loadWorkbook(fileOrBuffer){
  const buf=(fileOrBuffer instanceof ArrayBuffer)?fileOrBuffer:await fileOrBuffer.arrayBuffer();
  const wb=XLSX.read(buf,{type:'array'}); LAST_WB=wb;
  $('#sheetSel').innerHTML=wb.SheetNames.map((n,i)=>`<option value="${n}" ${i===0?'selected':''}>${n}</option>`).join('');
  return wb;
}
async function loadFromSelectedSheet(wb){
  wb=wb||LAST_WB; if(!wb) return;
  const name=$('#sheetSel').value||wb.SheetNames[0];
  CURRENT_SHEET = name;
  setStatus('info',`Gelesen aus Blatt: <b>${escapeHtml(name)}</b>.`,2500);
  const ws=wb.Sheets[name];
  const rows=extractRows(ws);
  GROUPS=buildGroups(rows); fillGroupFilter(); render();
  SELECTED.clear(); renderSummary(false);
  requestAnimationFrame(()=>{ jumpToTop(); recomputeChromeOffset(); });
  saveState({sheet:name});
}

/* ================= Events ============================= */
$('#manualBtn').addEventListener('click', () => $('#file').click());

$('#file').addEventListener('change', async e=>{
  const f=e.target.files&&e.target.files[0]; if(!f) return;
  if(!/\.(xlsx|xlsm)$/i.test(f.name)){ setStatus('warn','Nur <b>.xlsx</b> oder <b>.xlsm</b> erlaubt.',3500); e.target.value=''; return; }
  setStatus('info','Lade Datei‚Ä¶',2500);
  $('#currentFile').textContent=f.name;
  const wb=await loadWorkbook(f); await loadFromSelectedSheet(wb);
  setDrawer(false); setStatus('ok','Bereit.',1500);
  $('#manualBtn').style.display='none';
});

['#search','#fA','#fB','#fC'].forEach(sel=>{
  document.querySelector(sel).addEventListener('input',debounced(()=>{ render(); },150));
});

document.querySelector('#groupFilter').addEventListener('change', ()=>{
  render();
  requestAnimationFrame(()=>{ jumpToTop(); recomputeChromeOffset(); });
});

const sheetSel=$('#sheetSel'); let lastSheetValue=null;
sheetSel.addEventListener('focus',()=>{ lastSheetValue=sheetSel.value; });
sheetSel.addEventListener('mousedown',()=>{ lastSheetValue=sheetSel.value; });
sheetSel.addEventListener('change', async ()=>{
  const hasFilters = ($('#search').value||$('#fA').value||$('#fB').value||$('#fC').value||$('#groupFilter').value);
  const hasSelection = SELECTED.size>0;
  if(hasFilters||hasSelection){
    const ok=confirm('Blatt wechseln? Alle Filter und markierten Positionen werden zur√ºckgesetzt.');
    if(!ok){ sheetSel.value=lastSheetValue??sheetSel.value; return; }
  }
  await loadFromSelectedSheet(); setDrawer(false); setStatus('ok','Blatt gewechselt.',1500);
});

$('#reset').addEventListener('click', ()=>{
  if(!confirm('Alle Filter, Mengen und markierten Positionen werden zur√ºckgesetzt. Fortfahren?')) return;
  $('#search').value=$('#fA').value=$('#fB').value=$('#fC').value=''; $('#groupFilter').value=''; SORT={col:null,dir:1};
  render(); SELECTED.clear(); renderSummary(false); setDrawer(false); setStatus('info','Zur√ºckgesetzt.',1500);
  requestAnimationFrame(()=>{ jumpToTop(); recomputeChromeOffset(); });
});
$('#thPreis').addEventListener('click',()=>{ SORT.col='preis'; SORT.dir*= -1; render(); });

function setDrawer(open){
  DRAWER_OPEN=!!open;
  $('#summary').classList.toggle('open',DRAWER_OPEN);
  document.body.classList.toggle('drawer-open',DRAWER_OPEN);
  saveState(Object.assign(loadState(),{drawerOpen:DRAWER_OPEN}));
  requestAnimationFrame(recomputeChromeOffset);
}
document.addEventListener('click',(e)=>{ if(e.target && (e.target.id==='toggleDrawer' || e.target.closest('#toggleDrawer'))) setDrawer(!DRAWER_OPEN); });
$('#drawerHead').addEventListener('dblclick',()=>setDrawer(!DRAWER_OPEN));
document.addEventListener('keydown',(e)=>{ if(e.altKey && (e.key==='o' || e.key==='O')){ e.preventDefault(); setDrawer(!DRAWER_OPEN); } });

['#bvhInput','#auftragInput','#erstellerInput','#betreffInput'].forEach(sel=>{
  document.querySelector(sel).addEventListener('input',debounced(saveMeta,200));
});

/* Zusammenfassung + Feedback */
let lastSum = 0;
function showToast(){ const t=$('#toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1100); }
function pulseHead(){ const h=$('#drawerHead'); h.classList.add('pulse'); setTimeout(()=>h.classList.remove('pulse'), 800); }
function updateDelta(sum){
  const el=$('#selSum'); el.classList.remove('sum-up','sum-down');
  if(sum>lastSum){ el.classList.add('sum-up'); setTimeout(()=>el.classList.remove('sum-up'),1000); }
  else if(sum<lastSum){ el.classList.add('sum-down'); setTimeout(()=>el.classList.remove('sum-down'),1000); }
  lastSum = sum;
}

function renderSummary(feedback){
  const wrap=$('#summaryTableWrap');
  const items=[...SELECTED.values()].sort((a,b)=> String(a.id).localeCompare(String(b.id),'de',{numeric:true,sensitivity:'base'}));
  let sum=0;
  const rows=items.map(it=>{ sum+=it.totalNum;
    const kurzHTML = linkify(escapeHtml(it.kurz||''));
    const beschrHTML = linkify(escapeHtml(it.beschreibung||''));
    return `<tr>
      <td style="width:120px">${escapeHtml(it.id)}</td>
      <td style="min-width:220px"><div><b>${kurzHTML}</b></div><div class="desc">${beschrHTML}</div></td>
      <td class="right" style="width:120px">${fmtPrice(it.preisNum)}</td>
      <td class="right" style="width:90px">${fmtQty(it.qtyNum)} ${escapeHtml(it.eh)}</td>
      <td class="right${it.totalNum<0?' neg':''}" style="width:140px">${fmtPrice(it.totalNum)}</td>
    </tr>`; }).join('');
  wrap.innerHTML = `
    <table>
      <thead><tr><th>Art.Nr.</th><th>Bezeichnung (Kurztext + Beschreibung)</th><th class="right">EH-Preis</th><th class="right">Menge</th><th class="right">Gesamt</th></tr></thead>
      <tbody>${rows||''}</tbody>
      <tfoot><tr class="tot"><td colspan="4" class="right">Summe</td><td class="right${sum<0?' neg':''}">${fmtPrice(sum)}</td></tr></tfoot>
    </table>`;
  $('#selCount').textContent=String(items.length);
  $('#selSum').textContent=sum.toLocaleString('de-AT',{style:'currency',currency:'EUR'});
  if(feedback){ pulseHead(); showToast(); updateDelta(sum); setStatus('ok','Bereit.',1500); }
}

/* ============== Drucken (ein Fenster) ============== */
function buildPrintDoc(){
  const items=[...SELECTED.values()].sort((a,b)=> String(a.id).localeCompare(String(b.id),'de',{numeric:true,sensitivity:'base'}));
  if(items.length===0) return null;

  const BVH=($('#bvhInput')?.value||'').trim()||'‚Äì';
  const AUF=($('#auftragInput')?.value||'').trim()||'‚Äì';
  const ERS=($('#erstellerInput')?.value||'').trim()||'‚Äì';
  const BETR=($('#betreffInput')?.value||'').trim()||'‚Äì';
  const DAT=new Date().toLocaleDateString('de-AT');
  const SHEET = CURRENT_SHEET || '‚Äì';

  let tbody=''; let total=0;
  items.forEach(it=>{
    total+=it.totalNum;
    const kurzHTML = linkify(escapeHtml(it.kurz||''));
    const beschrHTML = linkify(escapeHtml(it.beschreibung||''));
    tbody+=`<tr class="item-row">
      <td>${escapeHtml(it.id)}</td>
      <td><div><b>${kurzHTML}</b></div><div class="desc">${beschrHTML}</div></td>
      <td class="right">${fmtPrice(it.preisNum)}</td>
      <td class="right">${fmtQty(it.qtyNum)} ${escapeHtml(it.eh)}</td>
      <td class="right${it.totalNum<0?' neg':''}">${fmtPrice(it.totalNum)}</td>
    </tr>`;
  });

  return `<!DOCTYPE html><html lang="de"><head><meta charset="utf-8"><title>Kostenvoranschlag</title>
  <style>
    @page { size: A4 portrait; margin: 16mm 14mm 16mm 14mm; }
    body{ font:12px/1.35 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial; color:#111; }

    .p-head{ display:grid; grid-template-columns: 1fr auto; column-gap: 16px; align-items:flex-start; margin-bottom:10px; }
    .title{ font-size:18px; font-weight:800; margin:0 0 6px 0; }
    .meta{ font-size:12px; line-height:1.45; }
    .meta b{ display:inline-block; min-width:120px; }
    .rightcol{ text-align:right; }
    .logo{ height:60px; margin-bottom:4px; display:block; margin-left:auto; }
    .created{ font-size:12px; white-space:nowrap; }

    table{ width:100%; border-collapse:collapse; }
    thead th{ text-align:left; padding:6px 6px; background:#fff6e6; border-bottom:1px solid #d8dee6; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    td{ padding:6px 6px; vertical-align:top; }
    tr.item-row{ page-break-inside: avoid; }
    td, th{ page-break-inside: avoid; }
    .right{ text-align:right; }
    .neg{ color:#b91c1c; font-weight:600; }
    .desc{ white-space:pre-wrap; }
    .desc a{ text-decoration:underline; word-break:break-all; }

    .grand-total{ page-break-inside: avoid; margin-top:10px; border-top:2px solid #bbb; display:grid; grid-template-columns:1fr 140px; gap:8px; align-items:center; font-weight:700; }
    .grand-total .label{ text-align:right; padding-right:8px; }
    .grand-total .value{ text-align:right; }

    .note{ margin-top:12px; font-size:11px; color:#374151; }
  </style></head><body>

    <div class="p-head">
      <div>
        <h1 class="title">Kostenvoranschlag</h1>
        <div class="meta">
          <div><b>BVH:</b> ${escapeHtml(BVH)}</div>
          <div><b>Auftragsnummer:</b> ${escapeHtml(AUF)}</div>
          <div><b>Ersteller:</b> ${escapeHtml(ERS)}</div>
          <div style="margin-top:4px"><b>Betreff:</b> ${escapeHtml(BETR)}</div>
        </div>
      </div>
      <div class="rightcol">
        <img src="Logo_Haas.jpg" class="logo" alt="Logo" />
        <div class="created"><b>Erstellt am:</b> ${escapeHtml(DAT)}</div>
      </div>
    </div>

    <table>
      <thead><tr>
        <th style="width:30px">Art.Nr.</th>
        <th>Kurztext und Beschreibung</th>
        <th class="right" style="width:50px">EH-Preis</th>
        <th class="right" style="width:80px">Menge</th>
        <th class="right" style="width:60px">Gesamt</th>
      </tr></thead>
      <tbody>${tbody}</tbody>
    </table>

    <div class="grand-total"><div class="label">Gesamtsumme</div><div class="value${total<0?' neg':''}">${(total).toLocaleString('de-AT',{style:'currency',currency:'EUR'})}</div></div>

    <div class="note">
      Der Preis versteht sich inkl. 20% MwSt.
      √Ñnderungen, Irrt√ºmer und Preis√§nderungen vorbehalten.
      <br>Hinweis: Grundlage der Preise laut <b>${escapeHtml(SHEET)}</b>.
    </div>

  </body></html>`;
}

document.getElementById('printSummary').addEventListener('click', async ()=>{
  if(SELECTED.size===0){ setStatus('warn','Keine markierten Positionen zum Drucken.',3000); return; }
  const html = buildPrintDoc(); if(!html){ setStatus('warn','Nichts zu drucken.',3000); return; }

  const iframe = document.createElement('iframe');
  Object.assign(iframe.style,{position:'fixed',right:'0',bottom:'0',width:'0',height:'0',border:'0'});
  iframe.setAttribute('aria-hidden','true');
  document.body.appendChild(iframe);

  const win = iframe.contentWindow, doc = win.document;
  doc.open(); doc.write(html); doc.close();

  const done = () => { try{ iframe.remove(); }catch{} };
  const safePrint = () => { try{ win.focus(); win.onafterprint = done; win.print(); } catch { done(); } }

  if (doc.readyState === 'complete') { setTimeout(safePrint, 250); }
  else { win.addEventListener('load', () => setTimeout(safePrint, 250), {once:true}); }
});

/* ================= Init =============================== */
window.addEventListener('DOMContentLoaded', async ()=>{
  const state = loadState();
  if(state.filters){ $('#search').value=state.filters.q||''; $('#fA').value=state.filters.A||''; $('#fB').value=state.filters.B||''; $('#fC').value=state.filters.C||''; $('#groupFilter').value=state.filters.group||''; }
  if(state.meta){ $('#bvhInput').value=state.meta.bvh||''; $('#auftragInput').value=state.meta.auftrag||''; $('#erstellerInput').value=state.meta.ersteller||''; $('#betreffInput').value=state.meta.betreff||''; }
  if(state.drawerOpen===true){ setDrawer(true); } else { setDrawer(false); }

  /* erste Messung vor Autoload */
  recomputeChromeOffset();

  setStatus('info','Automatisches Laden der <b>Artikelpreisliste.xlsx</b> (falls vorhanden).',2500);
  try{
    const res=await fetch(DEFAULT_FILE,{cache:'no-store'});
    if(res.ok){
      const buf=await res.arrayBuffer();
      $('#currentFile').textContent=DEFAULT_FILE;
      const wb=await loadWorkbook(buf);
      if(state.sheet && wb.SheetNames.includes(state.sheet)) $('#sheetSel').value=state.sheet;
      await loadFromSelectedSheet(wb);
      if(state.filters && state.filters.group) $('#groupFilter').value=state.filters.group;
      render(); setDrawer(false); setStatus('ok','Bereit.',1500);
      requestAnimationFrame(()=>{ jumpToTop(); recomputeChromeOffset(); });
      $('#manualBtn').style.display='none';
    }else{
      setStatus('warn',`Standarddatei <b>${DEFAULT_FILE}</b> konnte nicht geladen werden.`,4000);
      $('#manualBtn').style.display='inline-flex';
    }
  }catch{
    setStatus('warn',`Standarddatei <b>${DEFAULT_FILE}</b> konnte nicht geladen werden.`,4000);
    $('#manualBtn').style.display='inline-flex';
  }
});
</script>
</body>
</html>
